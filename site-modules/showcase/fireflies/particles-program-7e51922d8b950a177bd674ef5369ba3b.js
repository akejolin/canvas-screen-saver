import T from"./particle-ef14479ebe58ecddd31f4d2b486aed4d.js";import{randomNumBetween as d}from"./helpers-38882a545c1cac7384ff6d123701d97e.js";import{addInterval as f,removeInterval as p}from"./interval-handler-c2a464ee22e041ce506d89f42f719423.js";const I=e=>new Promise(t=>setTimeout(()=>{clearTimeout(),t()},e));function v(e){for(var t=e.length,r,n;t!==0;)n=Math.floor(Math.random()*t),t-=1,r=e[t],e[t]=e[n],e[n]=r;return e}export default class y{constructor(e){this.particles=[],this.preparticles=[],this.text=e.text,this.type="text",this.hasStarted=!1}getFont(e){const t=1e3,r=200;var n=r/t,o=e*n;return(o|0)+"px helvetica"}async drawText(e,t){const r=e.context;let{width:n,height:o}=e.screen;return new Promise(i=>{r.save(),r.clearRect(0,0,n,o),r.font=this.getFont(n),r.textAlign="center",r.fillText(t,n/2,o/2+250/2),r.restore(),i()})}async createNew(e,t){const r=e.context;await this.drawText(e,t||this.text);let{width:n,height:o}=e.screen;const i=await r.getImageData(0,0,n,o),c=i.data;r.clearRect(0,0,n,o),r.globalCompositeOperation="screen";const u=[],w=(h,x,g)=>{const m=x*(g*4)+h*4;return[m,m+1,m+2,m+3]},a=e.screen.size==="L"?e.screen.ratio*3:.1;for(var s=0;s<n;s+=Math.round(n/150))for(var l=0;l<o;l+=Math.round(n/150)){const h=w(s,l,n),[x,g,m,P]=h;c[(s+l*n)*4+3]>150&&u.push(new T({x:s,y:l,ww:n,wh:o,color:{r:c[x],g:c[g],b:c[m],a:c[P]},radius:Math.random()*a+2}))}return r.restore(),u}async init(e,t){this.preparticles=await this.createNew(e,t),this.startAddParticlesToRender(e)}async startAddParticlesToRender(e){let{particles:t,preparticles:r}=this;r=v(r);let n=r.length,o=8e3;for(;n>0;)n--,o=o>0?o-1:0,this.delay(d(0,o),()=>{t.push(r[n])});I(1e4).then(()=>{this.newAction(e)})}delay(e,t){setTimeout(t(),e)}newAction(e){let t=this.particles,r=t.length;const n=async()=>{t=v(t);const o=Math.round(250/2),i=d(Math.round(0-(e.screen.width/2-o)),Math.round(e.screen.width/2-o)),c=d(Math.round(0-(e.screen.height/2-o)),Math.round(e.screen.height/2-o)),u=(s,l)=>new Promise(h=>{t[s].setNewTarget({x:t[s].originPosition.x+i,y:t[s].originPosition.y+c}),setTimeout(()=>h(),d(0,l))}),w=(s,l)=>new Promise(h=>{t[s].setNewTarget({x:t[s].originPosition.x+d(-i,i),y:t[s].originPosition.y+d(-c,c)}),setTimeout(()=>h(),d(0,l))});let a=8e3;p("time-to-move"),f("time-to-move",500,()=>{for(p("time-to-move"),r=t.length;r>0;)r=r-1,a=a>0?a-1:0,w(r,a)}),p("time-to-shape"),f("time-to-shape",1e3,()=>{for(p("time-to-shape"),r=t.length;r>0;)r=r-1,a=a>0?a-1:0,u(r,a)}),p("time-for-next-round"),f("time-for-next-round",15e3,()=>{p("time-for-next-round"),n()})};n()}render(e){const{width:t,height:r}=e.screen,n=e.context;n.clearRect(0,0,t,r);const{particles:o}=this;for(var i=o.length;i>0;)i--,o[i].delete===!0?o.splice(i,1):o[i].render(e)}}
